<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Chapter 13 Creating new measures | Urban Informatics Toolkit</title>
<meta name="author" content="Josiah Parry">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.2"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/header-attrs-2.5.3/header-attrs.js"></script><script src="libs/jquery-3.5.1/jquery-3.5.1.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.5.3/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.5.3/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.2.3.9000/tabs.js"></script><script src="libs/bs3compat-0.2.3.9000/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/accessible-code-block-0.0.1/empty-anchor.js"></script><script src="https://cdn.jsdelivr.net/autocomplete.js/0/autocomplete.jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/mark.js@8.11.1/dist/mark.min.js"></script><!-- CSS -->
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Urban Informatics Toolkit</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html"><span class="header-section-number">1</span> Welcome</a></li>
<li class="book-part">Foundations of Urban Informatics</li>
<li><a class="" href="the-utility-and-danger-of-big-data.html"><span class="header-section-number">2</span> The Utility and Danger of Big Data</a></li>
<li><a class="" href="data-in-the-municipal-context.html"><span class="header-section-number">3</span> Data in the municipal context</a></li>
<li><a class="" href="approaches-to-and-schools-of-urban-informatics.html"><span class="header-section-number">4</span> Approaches to and Schools of Urban Informatics</a></li>
<li><a class="" href="ecometrics.html"><span class="header-section-number">5</span> Ecometrics</a></li>
<li class="book-part">Toolkit Foundations</li>
<li><a class="" href="the-basics.html"><span class="header-section-number">6</span> The basics</a></li>
<li><a class="" href="r-as-a-calculator.html"><span class="header-section-number">7</span> R as a calculator</a></li>
<li><a class="" href="reading-data.html"><span class="header-section-number">8</span> Reading data</a></li>
<li><a class="" href="exploratory-visual-analysis.html"><span class="header-section-number">9</span> Exploratory Visual Analysis</a></li>
<li><a class="" href="general-data-manipulation.html"><span class="header-section-number">10</span> General data manipulation</a></li>
<li><a class="" href="thats-too-much-data.html"><span class="header-section-number">11</span> That’s too much data</a></li>
<li><a class="" href="the-pipe.html"><span class="header-section-number">12</span> The pipe %&gt;%</a></li>
<li><a class="active" href="creating-new-measures.html"><span class="header-section-number">13</span> Creating new measures</a></li>
<li><a class="" href="data-structures.html"><span class="header-section-number">14</span> Data Structures</a></li>
<li><a class="" href="summary-statistics.html"><span class="header-section-number">15</span> Summary statistics</a></li>
<li><a class="" href="summarizing-the-tidy-way.html"><span class="header-section-number">16</span> Summarizing the tidy way</a></li>
<li><a class="" href="toolkit-review.html"><span class="header-section-number">17</span> Toolkit review</a></li>
<li class="book-part">Vizualization Strategies</li>
<li><a class="" href="layered-i.html"><span class="header-section-number">18</span> Grammar of layered graphics I</a></li>
<li><a class="" href="visualizing-trends-and-relationships.html"><span class="header-section-number">19</span> Visualizing Trends and Relationships</a></li>
<li><a class="" href="grammer-of-layered-graphics-ii.html"><span class="header-section-number">20</span> Grammer of layered graphics II</a></li>
<li><a class="" href="visualizing-beyond-2-dimensions.html"><span class="header-section-number">21</span> Visualizing beyond 2-dimensions</a></li>
<li><a class="" href="visualizing-through-time.html"><span class="header-section-number">22</span> Visualizing through time</a></li>
<li><a class="" href="visualization-review.html"><span class="header-section-number">23</span> Visualization Review</a></li>
<li class="book-part">Expanding the Toolkit</li>
<li><a class="" href="multiple-data-sets.html"><span class="header-section-number">24</span> Multiple data sets</a></li>
<li><a class="" href="statistics.html"><span class="header-section-number">25</span> Statistics</a></li>
<li><a class="" href="spatial-analysis.html"><span class="header-section-number">26</span> Spatial Analysis</a></li>
</ul>

        <div class="book-extra">
          
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="creating-new-measures" class="section level1" number="13">
<h1>
<span class="header-section-number">13</span> Creating new measures<a class="anchor" aria-label="anchor" href="#creating-new-measures"><i class="fas fa-link"></i></a>
</h1>
<p>It’s been a week now and the non-profit has finally emailed you back. They were ecstatic with what you provided but it begat even more questions for them. They indicated that while the median household income data was very intruiging, that would be difficult for them to report on. As such, they would like you to report on the income quintiles as well. Moreover, they also would like to see the rate of Bachelor’s and Master’s degrees combined into one general educational attainment variable.</p>
<p>This poses some challenges for you. You know <em>what</em> is being asked, just not necessarily <em>how</em> to achieve that from R. To accomplish this we’re going to have to learn how to use the <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">dplyr::mutate()</a></code> function. For the sake of example, let’s select only the columns that we’re going to need and make a tibble called <code>df</code> just to work with.</p>
<div class="sourceCode" id="cb118"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span>

<span class="va">commute</span> <span class="op">&lt;-</span> <span class="fu">read_csv</span><span class="op">(</span><span class="st">"data/gba_commute.csv"</span><span class="op">)</span>
<span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">commute</span>, <span class="va">med_house_income</span>, <span class="va">bach</span>, <span class="va">master</span><span class="op">)</span>

<span class="va">df</span>
<span class="co">#&gt; # A tibble: 648 x 3</span>
<span class="co">#&gt;    med_house_income  bach master</span>
<span class="co">#&gt;               &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;</span>
<span class="co">#&gt;  1            75085 0.188 0.100 </span>
<span class="co">#&gt;  2           132727 0.400 0.130 </span>
<span class="co">#&gt;  3           110694 0.317 0.139 </span>
<span class="co">#&gt;  4           109125 0.322 0.144 </span>
<span class="co">#&gt;  5            76746 0.177 0.0742</span>
<span class="co">#&gt;  6           138700 0.310 0.207 </span>
<span class="co">#&gt;  7           104673 0.247 0.149 </span>
<span class="co">#&gt;  8            73191 0.300 0.126 </span>
<span class="co">#&gt;  9           121488 0.198 0.140 </span>
<span class="co">#&gt; 10            99358 0.348 0.151 </span>
<span class="co">#&gt; # … with 638 more rows</span></code></pre></div>
<p><code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code> is a function that let’s us create or modify variables. The arguments for <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code> are the same as those for <code><a href="https://dplyr.tidyverse.org/reference/select.html">select()</a></code>—<code>.data</code> and <code>...</code>. In the case of <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate()</a></code> dots works a littble bit differently. After indicating our data, we create columns by specifying a name-value pair. More simply the names of our arguments will be the name of the columns that we are creating. The value is any expression. For example we could use <code><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate(df, one = 1)</a></code> to create a column called <code>one</code> with the value of 1. When using mutate, however, the result from the expression needs to be either only <em>one</em> value, or as many values as there are rows.</p>
<p>If we take our <code>df</code>, we can add the columns <code>bach</code> and <code>master</code> together to create a new column called <code>edu_attain</code>.</p>
<div class="sourceCode" id="cb119"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="va">df</span>, edu_attain <span class="op">=</span> <span class="va">bach</span> <span class="op">+</span> <span class="va">master</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 648 x 4</span>
<span class="co">#&gt;    med_house_income  bach master edu_attain</span>
<span class="co">#&gt;               &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;      &lt;dbl&gt;</span>
<span class="co">#&gt;  1            75085 0.188 0.100       0.288</span>
<span class="co">#&gt;  2           132727 0.400 0.130       0.531</span>
<span class="co">#&gt;  3           110694 0.317 0.139       0.456</span>
<span class="co">#&gt;  4           109125 0.322 0.144       0.466</span>
<span class="co">#&gt;  5            76746 0.177 0.0742      0.251</span>
<span class="co">#&gt;  6           138700 0.310 0.207       0.516</span>
<span class="co">#&gt;  7           104673 0.247 0.149       0.396</span>
<span class="co">#&gt;  8            73191 0.300 0.126       0.426</span>
<span class="co">#&gt;  9           121488 0.198 0.140       0.338</span>
<span class="co">#&gt; 10            99358 0.348 0.151       0.499</span>
<span class="co">#&gt; # … with 638 more rows</span></code></pre></div>
<p>We could even think about ways that we can check if some observations are above some specified income threshold.</p>
<div class="sourceCode" id="cb120"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="va">df</span>, above_70k_inc <span class="op">=</span> <span class="va">med_house_income</span> <span class="op">&gt;</span> <span class="fl">80000</span><span class="op">)</span> 
<span class="co">#&gt; # A tibble: 648 x 4</span>
<span class="co">#&gt;    med_house_income  bach master above_70k_inc</span>
<span class="co">#&gt;               &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt; &lt;lgl&gt;        </span>
<span class="co">#&gt;  1            75085 0.188 0.100  FALSE        </span>
<span class="co">#&gt;  2           132727 0.400 0.130  TRUE         </span>
<span class="co">#&gt;  3           110694 0.317 0.139  TRUE         </span>
<span class="co">#&gt;  4           109125 0.322 0.144  TRUE         </span>
<span class="co">#&gt;  5            76746 0.177 0.0742 FALSE        </span>
<span class="co">#&gt;  6           138700 0.310 0.207  TRUE         </span>
<span class="co">#&gt;  7           104673 0.247 0.149  TRUE         </span>
<span class="co">#&gt;  8            73191 0.300 0.126  FALSE        </span>
<span class="co">#&gt;  9           121488 0.198 0.140  TRUE         </span>
<span class="co">#&gt; 10            99358 0.348 0.151  TRUE         </span>
<span class="co">#&gt; # … with 638 more rows</span></code></pre></div>
<p>This function is immensly useful and can be combined with almost any expression to create new data for us. Furthermore there are a number of handy functions built into dplyr that help us create new columns. Some of these are <code><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when()</a></code>, <code><a href="https://dplyr.tidyverse.org/reference/ranking.html">min_rank()</a></code>, and <code><a href="https://dplyr.tidyverse.org/reference/ranking.html">ntile()</a></code> among others. You can always explore these with <code>?function_name()</code>. For our purposes, we will look at the use of <code><a href="https://dplyr.tidyverse.org/reference/ranking.html">ntile()</a></code>.</p>
<p><code><a href="https://dplyr.tidyverse.org/reference/ranking.html">ntile()</a></code> is a function that will calculate percentiles for us. Given a column of data, <code>x</code>, and a number of buckets, <code>n</code>, we can create a new column of ranks. In our case, we are interested in calculating the quintile of <code>med_house_income</code>. This means we can provide <code>med_house_income</code> and <code>n = 5</code> as arguments to <code><a href="https://dplyr.tidyverse.org/reference/ranking.html">ntile()</a></code> to group our observations by quintile.</p>
<div class="sourceCode" id="cb121"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="va">df</span>, inc_quintile <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/ranking.html">ntile</a></span><span class="op">(</span><span class="va">med_house_income</span>, <span class="fl">5</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; # A tibble: 648 x 4</span>
<span class="co">#&gt;    med_house_income  bach master inc_quintile</span>
<span class="co">#&gt;               &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;        &lt;int&gt;</span>
<span class="co">#&gt;  1            75085 0.188 0.100             2</span>
<span class="co">#&gt;  2           132727 0.400 0.130             5</span>
<span class="co">#&gt;  3           110694 0.317 0.139             4</span>
<span class="co">#&gt;  4           109125 0.322 0.144             4</span>
<span class="co">#&gt;  5            76746 0.177 0.0742            2</span>
<span class="co">#&gt;  6           138700 0.310 0.207             5</span>
<span class="co">#&gt;  7           104673 0.247 0.149             4</span>
<span class="co">#&gt;  8            73191 0.300 0.126             2</span>
<span class="co">#&gt;  9           121488 0.198 0.140             5</span>
<span class="co">#&gt; 10            99358 0.348 0.151             4</span>
<span class="co">#&gt; # … with 638 more rows</span></code></pre></div>
<p>Now we can put everything together into one mutate call to create the new variables that were requested!</p>
<div class="sourceCode" id="cb122"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">updated_commute</span> <span class="op">&lt;-</span> <span class="va">commute</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>edu_attain <span class="op">=</span> <span class="va">bach</span> <span class="op">+</span> <span class="va">master</span>, 
         inc_quintile <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/ranking.html">ntile</a></span><span class="op">(</span><span class="va">med_house_income</span>, <span class="fl">5</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>As you have made these changes you can now write the data again to csv and share it. As this process becomes more and more iterative, it’s good to put <em>some</em> structure to the data so you have an idea of the history. One general practice that is good to get into is dating your files. So in this case I would label the file <code>yyyy-mm-dd-commute.csv</code>.</p>

</div>
  <div class="chapter-nav">
<div class="prev"><a href="the-pipe.html"><span class="header-section-number">12</span> The pipe %&gt;%</a></div>
<div class="next"><a href="data-structures.html"><span class="header-section-number">14</span> Data Structures</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav"><li><a class="nav-link" href="#creating-new-measures"><span class="header-section-number">13</span> Creating new measures</a></li></ul>

      <div class="book-extra">
        <ul class="list-unstyled">
          
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Urban Informatics Toolkit</strong>" was written by Josiah Parry. It was last built on 2020-12-12.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>
</html>
